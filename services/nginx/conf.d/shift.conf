map $sent_http_content_type $expires {
    default		off;
    ~image/		48h;
}

server {

    listen 443;

    ssl    on;
    ssl_certificate     /opt/nginx/ssl/default.crt;
    ssl_certificate_key /opt/nginx/ssl/default.key;

    server_name _;
    charset utf-8;
    expires $expires;

    error_log  /var/log/nginx/error.log debug;
    access_log /var/log/nginx/access.log;

    # see also manage_event.js which has its own limits
    # and edit.html which describes the limit; 
    # this is slightly larger than the described limit to account for the json
    # and to be a little forgiving generally.
    client_max_body_size 2250k;

    # -----------------------------------------------
    # node endpoints
    # note: these uses "http://node" because the docker containers
    # have hostnames equal to their container names
    # ( see https://docs.docker.com/compose/networking/ )
    # -----------------------------------------------

    # replace ics.php with the newer ical.php
    location = /api/ics.php {
        proxy_pass http://node:3080/api/ical.php;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # replace the legacy pedalp endpoint with a range
    location = /api/pedalpalooza-calendar.php {
        # set to a constant range for this year's pedalp
        # alt, could set to the blank string "" and it would return 3 month range
        # or could customize the endpoint with a "pedalpalooza" parameter or something.
        proxy_pass http://node:3080/api/ical.php?startdate=2024-06-01&enddate=2024-08-31&filename=pedalpalooza-2024.ics;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # note: app/app.js remaps incoming ".php" extensions to ".js" endpoints
    location /api/ {
        # note the trailing slash on the proxy; that causes nginx to strip /api/ completely.
        proxy_pass http://node:3080/api/;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # -----------------------------------------------
    # event images
    # -----------------------------------------------

    # handle images of the standard shift format 
    # ex. /eventimages/9248-124.png
    #
    location ~ /eventimages/(\d+)(?:-\d+).(\w+) {
        alias /opt/backend/eventimages/$1.$2;
        expires max;
    }

    # a fallback for images that don't fit the expected format for some reason.
    #
    location /eventimages {
        alias /opt/backend/eventimages;
    }

    # -----------------------------------------------
    # development endpoints
    # these map to the local static site used when running docker in development
    # netlify handles the static site in production
    # ------------------------------------------------

    location /calendar {
        root /var/www/site;
        try_files $uri $uri/ /calendar/index.html;
    }

    location /addevent {
        root /var/www/site;
        try_files $uri $uri/ /addevent/index.html;
    }

    location / {
        root /var/www/site;
    }
}
