##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
	map $sent_http_content_type $expires {
	    default		off;
	    ~image/		48h;
	}

server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;
        ssl_certificate /etc/letsencrypt/live/beta.shift2bikes.org/cert.pem;
        ssl_certificate_key /etc/letsencrypt/live/beta.shift2bikes.org/privkey.pem;

        root /opt/shift-docs/site/public/;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;



	charset utf-8;
	expires $expires;

	error_log  /var/log/nginx/error.log debug;
	access_log /var/log/nginx/access.log;

# see also manage_event.php which has its own limits
# and edit.html which describes the limit;
# this is slightly larger than the described limit to account for the json
# and to be a little forgiving generally.
client_max_body_size 2250k;

# replace ics.php with the newer ical.php
#location ^~ /api/ics.php {
#    fastcgi_pass php:9000;
#    include fastcgi_params;
#    fastcgi_param HTTP_PROXY "";
#    fastcgi_param SCRIPT_FILENAME /opt/backend/www/ical.php;
#}

# replace the legacy pedalp endpoint with a range
#location ^~ /legacy/cal/new-icalpp.php {
#    fastcgi_pass php:9000;
#    include fastcgi_params;
#    fastcgi_param HTTP_PROXY "";
#    # set to a constant range for this year's pedalp
    # alt, could set to the blank string "" and it would return 3 month range
#    fastcgi_param QUERY_STRING "startdate=2023-06-01&enddate=2023-08-31&filename=pedalpalooza-2023.ics";
#    fastcgi_param SCRIPT_FILENAME /opt/backend/www/ical.php;
#}

location ~ /api/.*\.php(/|$) {
    # split the filename (e.g. manage_event) out of the path
    # so PHP can find the file in /opt/backend/www
    # stores the first regex group as "$fastcgi_script_name"
    # and the second group as "$fastcgi_path_info"
    # ( query string is handled separately )
    fastcgi_split_path_info ^/api/(.+?\.php)(.*)$;

    # if the named file doesnt exist on disk; return 404 ( not found )
    if (!-f /opt/backend/www/$fastcgi_script_name) {
        return 404;
    }

#    fastcgi_param HTTP_PROXY ""; # mitigate https://httpoxy.org/ vulnerabilities
#    fastcgi_pass php:9000;       # the php-fpm ( FastCGI Process Manager ) uses port 9000 .
#    fastcgi_index index.php;     # fix: remove. meant for queries ending in slash; no such file exists.
#    include fastcgi_params;      # include the /etc/nginx/fastcgi_params file

    # below path is PHP's path, not nginx
#    fastcgi_param SCRIPT_FILENAME /opt/backend/www/$fastcgi_script_name;
#}

# fix? should this be removed to prevent access to legacy files?
location /legacy/cal {
    alias /opt/legacy/cal;
}

# handle images of the standard shift format
# ex. /eventimages/9248-124.png
#
location ~ /eventimages/(\d+)(?:-\d+).(\w+) {
    alias /opt/backend/eventimages/$1.$2;
    expires max;
}

# a fallback for images that don't fit the expected format for some reason.
#
location /eventimages {
    alias /opt/backend/eventimages;
}

location /calendar {
    root /var/www/site;
    try_files $uri $uri/ /calendar/index.html;
}

location /addevent {
    root /var/www/site;
    try_files $uri $uri/ /addevent/index.html;
}

location / {
    root /var/www/site;
}
}


## old default config below here, can remove 26 feb 2024 - fool
#        server_name _;
#
#        location / {
#                # First attempt to serve request as file, then
#                # as directory, then fall back to displaying a 404.
#                try_files $uri $uri/ =404;
#        }
#
#        # pass PHP scripts to FastCGI server
#        #
#        #location ~ \.php$ {
#        #       include snippets/fastcgi-php.conf;
#        #
#        #       # With php-fpm (or other unix sockets):
#        #       fastcgi_pass unix:/run/php/php7.4-fpm.sock;
#        #       # With php-cgi (or other tcp sockets):
#        #       fastcgi_pass 127.0.0.1:9000;
#        #}
#
#        # deny access to .htaccess files, if Apache's document root
#        # concurs with nginx's one
#        #
#        #location ~ /\.ht {
#        #       deny all;
#        #}
#}
#
#
## Virtual Host configuration for example.com
##
## You can move that to a different file under sites-available/ and symlink that
## to sites-enabled/ to enable it.
##
##server {
##       listen 80;
##       listen [::]:80;
##
##       server_name example.com;
##
##       root /var/www/example.com;
##       index index.html;
##
##       location / {
##               try_files $uri $uri/ =404;
##       }
##}
